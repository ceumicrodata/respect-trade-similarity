
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   15.1   Copyright 1985-2017 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

Single-user 2-core Stata perpetual license:
       Serial number:  501506203290
         Licensed to:  Miklos Koren
                       CEU MicroData

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  More than 2 billion observations are allowed; see help obs_advice.
      4.  Maximum number of variables is set to 5000; see help set_maxvar.

. do test.do 

. clear all

. import delimited IMP_cn2017.csv
(5 vars, 1,971,283 obs)

. 
. do KLD.do

. preserve 

. 
. * calculate aggregate trade share of products for each partner country
. collapse (sum) value_in_euros , by(partner_iso product_nc )

. egen country_total = sum(value_in_euros ), by(partner_iso )

. gen eu_share = value_in_euros / country_total 

. 
. keep partner_iso product_nc eu_share 

. tempfile eu_share

. save `eu_share', replace
(note: file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//St30992.000002 no
> t found)
file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//St30992.000002 saved

. 
. restore

. 
. egen country_total = sum(value_in_euros ), by(declarant_iso partner_iso )

. gen share = value_in_euros / country_total 

. 
. merge m:1 partner_iso product_nc using `eu_share', nogen keep(match master)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         1,971,283  
    -----------------------------------------

. 
. * if EU share is zero, that product does not enter KLD calculation
. drop if eu_share == 0
(66 observations deleted)

. assert eu_share > 0 & !missing(eu_share)

. 
. gen KLD = share * log(share / eu_share)
(430 missing values generated)

. * 0 log(0) = 0
. replace KLD = 0 if share == 0
(430 real changes made)

. 
. collapse (sum) KLD, by(declarant_iso partner_iso)

. 
. 
end of do-file

. 
. su KLD, d

                          (sum) KLD
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .1125376       .0506903
 5%     .2060237       .0567886
10%     .2665138       .0647291       Obs                 814
25%     .4318626         .06507       Sum of Wgt.         814

50%     .7034315                      Mean           .8619902
                        Largest       Std. Dev.      .6892645
75%     1.102604       4.758369
90%     1.554031       5.654855       Variance       .4750856
95%      1.85274       6.879393       Skewness       3.276845
99%     3.115017       6.903027       Kurtosis       22.37057

. save KLD.dta, replace
(note: file KLD.dta not found)
file KLD.dta saved

. 
end of do-file
